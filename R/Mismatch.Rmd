---
title: "Title"
author: "Keisuke Atsumi"
date: '`r format(Sys.time(), "%y/%m/%d %H:%M")`'
output:
  html_document:
    code_download: true
    code_folding: hide
    theme: united # “default”, “cerulean”, “journal”, “flatly”, “darkly”, “readable”, “spacelab”, “united”, “cosmo”, “lumen”, “paper”, “sandstone”, “simplex”, “yeti”
    toc: yes
    toc_float: yes

---

```{r}

rm(list=ls())  # reset workspace
options(scipen=100)  # do not show numbers using exponential

# install & load packages
pacman::p_load(
  openxlsx   # open excel
  , tidyverse
  , magrittr   # extended pipe
  , MCMCglmm   # comparative analysis
  , rotl       # open tree of life
  , ape        # Phylogeny
  , phytools   # Phylogeny
  , knitr  
  , kableExtra # nice tables
  , pander     # nice tables
  , ggtree
  # , R.rsp
)

# Rmarkdown settings
knitr::opts_chunk$set(
  prompt  = FALSE,  # Do not add > or + in inline-code
  message = FALSE, 
  comment = "", 
  warning = FALSE,  # Mute warnings
  tidy    = TRUE
  ) 
options(knitr.kable.NA = '') # Hide NAs in kable table

## Phenotype data ##
pheno <- read.xlsx(
    "../data/original.data.xlsx", sheet = "Phenotype"
    ) %>%
  # Excluding data without any parent data
  drop_na(contains("SD.sp")) %>%
  # to numeric
  mutate_at(
    vars(contains("Mn") | contains("SD") | N.sp1:N.sp2), 
    as.numeric
    ) %>%
  # delete observation with negative mean trait value
  filter(Mn.sp1 > 0 & Mn.sp2 > 0 & homologous == "Yes") %>%   
  # calculate phenotypic difference between parental species
  mutate(
    Pheno.divergence = abs(log(Mn.sp1/Mn.sp2))
    ) %>%
  mutate_at(vars(contains("pheno.div")), scale) %>%
  # describe whether full cross or not
  mutate(
    Reciprocal = ifelse(
      is.na(Mn.hyb12 & Mn.hyb21), 
      "Inviable", "Viable"
      )
    )

meta <- read.xlsx(
    "../data/original.data.xlsx", sheet = "Metadata"
    ) %>%
  mutate_at(vars(contains("divergence")), as.numeric) %>%
  # Logalize genetic divergence
  mutate_at(vars(contains("divergence")), log10)

original.dat <- left_join(pheno, meta)
# add unique ID for each effect size (row)
original.dat$ES.ID <- paste("ES", sprintf("%03d",c(1:dim(original.dat)[1])), sep="")

```


# d<sub>mismatch</sub> calculation

Following [Thompson 2019](https://www.biorxiv.org/content/10.1101/818658v1.full#disp-formula-1), d<sub>mismatch</sub>  calculation has two important part:

**Standardizing hybrid trait value using parent trait value** <br>
Standardized hybrid trait value in trait $i$, $Z_i$ is <br>
$Z_i = \frac{hyb_i - spSS_i}{spLL_i - spSS_i}$ <br>
This will put hybrid trait mean to 0-1, if not transgressed. But, this standardised value is sensitive to absolute trait size: large trait size with relatively small parental phenotypic divergence, transgressive hybrid phenotype will be scored as quite large *standardized* trait value. This seems occurred in mice (see bellow) <br>

**Calculate d<sub>mismatch</sub>** <br>
$d_{mismatch} = \sqrt{2} * \sqrt{ Z_i^2 + Z_j^2 - \frac{Z_i + Z_j}{\sqrt{2}}^2 }$
eqn 2 and 4 in [Thompson 2019](https://www.biorxiv.org/content/10.1101/818658v1.full#disp-formula-1). <br>

```{r}

dat <- original.dat %>%
  select(Study.ID, Cross.ID, taxa, Genus, Reciprocal, contains("Mn")) %>%
  # Gather reciprocal hybrid data
  gather(
    key = Hybrid, value = Mn.hybrid, 
    -c(Study.ID, Cross.ID, taxa, Genus, Reciprocal), -contains("Mn.sp")
    ) %>%
  drop_na(Mn.hybrid) %>%
  # Calculate standardized hybrid phenotype mean *** important part ***
  mutate(
    Dominance = ifelse(
      Mn.sp1 > Mn.sp2, 
      (Mn.hybrid - Mn.sp2)/abs(Mn.sp1 - Mn.sp2),
      (Mn.hybrid - Mn.sp1)/abs(Mn.sp1 - Mn.sp2)
    )
  ) %>%
  mutate_at("Cross.ID", as.factor) %>%
  arrange(taxa, Genus, Cross.ID, Hybrid) %>%
  # only get crosses with > 2 traits
  # Reciprocal hybrids are separated
  group_by(Cross.ID, Hybrid, taxa, Genus, Study.ID, Reciprocal) %>%
  filter(n() > 2) %>%
  # Create all combinations of standardized hybrid phenotype mean
  do(data.frame(t(combn(.$Dominance, 2)))) %>%
  # Calculate dominance mismatch *** important part ***
  mutate(
    Mismatch = sqrt(2) * sqrt( X1^2 + X2^2 - ( (X1 + X2) / sqrt(2) )^2 ),
    Mismatch.log = log(Mismatch)
  ) %>%
  left_join(meta) %>%
  mutate_if(is.character, as.factor) %>%
  within(taxa <- ordered(taxa, levels = c("Neuroptera", "Coleoptera", "Diptera", "Lepidoptera", "Orthoptera", "Aves", "Rodentia", "Anura", "Cichliformes"))) %>%
  as.data.frame

dat %>% 
  summarise(
    'Trait combination' = length(X1),
    'Species pair' = length(unique(species.pair)),
    'Crossing' = length(unique(Cross.ID))
    ) %>% 
  kable("html") %>% kable_styling("striped", position = "left")

```

# Plot d<sub>mismatch</sub> 

d<sub>mismatch</sub> is quite large in crossing involving mices (musculus), due to large trait value
```{r}
ggplot(data = dat, aes(x = Cross.ID, y = Mismatch)) +
  geom_point(alpha = 0.4, aes(color = Hybrid)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(~taxa, scales = "free")

ggplot(
  data = dat %>%
    filter(!grepl("musculus", Cross.ID)), 
  aes(x = Cross.ID, y = Mismatch)) +
  geom_point(alpha = 0.4, aes(color = Hybrid)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(~taxa, scales = "free")
```

log(d<sub>mismatch</sub>) looking good
```{r}
ggplot(data = dat, aes(x = Cross.ID, y = Mismatch.log)) +
  geom_point(alpha = 0.4, aes(color = Hybrid)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(~taxa, scales = "free")
```

# Analyze d<sub>mismatch</sub> 

Conducted MCMCglmm employing Gaussian distribution for raw d<sub>mismatch</sub> and log(d<sub>mismatch</sub>). <br>
Included study (`Study.ID`), phylogeny (`sp1.name`), crossed strain (`Cross.ID`) and cross direction (`Hybrid`) as random effects. SE was not taken into account.

```{r}

#++++++++++++++++++++++++++++++++++#
# Phylogenetic tree for mcmcglmm 
#++++++++++++++++++++++++++++++++++#

# compute branch lengths of tree
phylo_branch <- read.tree(file = "../data/phylo.novelty.tre") %>%
  compute.brlen(method = "Grafen", power = 1)
plot.phylo(phylo_branch, cex = 0.7)
# png("Fig.S2_phylogeny.png", width = 800, height = 600)
# plot.phylo(phylo_branch, cex = 0.7)
# dev.off()

# # saving phylogeneic matrix
# phylo_cor <- vcv(phylo_branch, cor = T)
# 
# # generating inverse phylogenetic matrix for MCMCglmm
# phylo_branch$node.label <- NULL
# phylo_MCMC <- MCMCglmm::inverseA(phylo_branch, nodes = "ALL", scale = TRUE)$Ainv

dat2 <- drop_na(dat, Mismatch.log)

# ### Log mismatch data ###

# ### Mismatch data ###
# phylmix <-MCMCglmm(
#   fixed = Mismatch ~  1,
#   # idh(SE):units | weight by SE of effect size
#   random = ~ Study.ID + sp1.name + Cross.ID + Hybrid,
#   verbose = FALSE,
#   ginverse = list(sp1.name = phylo_MCMC),
#   nitt = 60000,  # Increase the number of iterations, default is 13000
#   burnin = 5000,  # Increase the number of burnin, default is 3000
#   data = dat
# )
# saveRDS(phylmix, file = "../Analysis/mismatch.obj")

```

### Log d<sub>mismatch</sub>
```{r}
# phylmix <-MCMCglmm(
#   fixed = Mismatch.log ~  1,
#   # idh(SE):units | weight by SE of effect size
#   random = ~ Study.ID + sp1.name + Cross.ID + Hybrid,
#   verbose = FALSE,
#   ginverse = list(sp1.name = phylo_MCMC),
#   nitt = 60000,  # Increase the number of iterations, default is 13000
#   burnin = 5000,  # Increase the number of burnin, default is 3000
#   data = dat2
# )
# saveRDS(phylmix, file = "../Analysis/mismatch.log.obj")

phylmix <- readRDS("../Analysis/mismatch.log.obj")

### Fixed effects output ###
summary(phylmix)$solutions %>% 
  kable("html") %>% kable_styling("striped", position = "left")
```
Yielded obviously wrong (too large) estimates. Prior, which is default, may be wrong.


### Raw d<sub>mismatch</sub> 
Overall strength of mismatch
```{r}
# phylmix <-MCMCglmm(
#   fixed = Mismatch ~  1,
#   # idh(SE):units | weight by SE of effect size
#   random = ~ Study.ID + sp1.name + Cross.ID + Hybrid,
#   verbose = FALSE,
#   ginverse = list(sp1.name = phylo_MCMC),
#   nitt = 60000,  # Increase the number of iterations, default is 13000
#   burnin = 5000,  # Increase the number of burnin, default is 3000
#   data = dat
# )
# saveRDS(phylmix, file = "../Analysis/mismatch.obj")

phylmix <- readRDS("../Analysis/mismatch.obj")

### Fixed effects output ###
summary(phylmix)$solutions %>% 
  kable("html") %>% kable_styling("striped", position = "left")

### Random effects output ###  
summary(phylmix$VCV)$statistics %>%
  as.data.frame %>%
  kable("html", digits = 3, caption = "Random effects") %>% 
  kable_styling("striped", position = "left")

```
Even data included quite large d<sub>mismatch</sub>, overall it did not differ from 0. But the estimate (ca. 4) is still much larger than Thompson et al reporting mean d<sub>mismatch</sub> is 0.6. This is presumably because transgression (novel phenotype expression), which should increase d<sub>mismatch</sub>, is much more frequent in our data compared to Thompson et al.

### Raw mismatch for each cross
```{r}
# phylmix <-MCMCglmm(
#   fixed = Mismatch ~ Cross.ID -1,
#   # idh(SE):units | weight by SE of effect size
#   random = ~ Study.ID + sp1.name + Hybrid,
#   verbose = FALSE,
#   ginverse = list(sp1.name = phylo_MCMC),
#   nitt = 60000,  # Increase the number of iterations, default is 13000
#   burnin = 5000,  # Increase the number of burnin, default is 3000
#   data = dat
# )
# saveRDS(phylmix, file = "../Analysis/mismatch.eachcross.obj")

phylmix <- readRDS("../Analysis/mismatch.eachcross.obj")

### Fixed effects output ###
left_join(
  # corrected estimates & SD
  summary(phylmix$Sol)$statistics %>%
    as.data.frame() %>%
    rownames_to_column(var = "Cross.ID"),
  # P
  summary(phylmix)$solutions %>%
  as.data.frame() %>%
    rownames_to_column(var = "Cross.ID"),
  by = "Cross.ID"
  ) %>%
  mutate(significance = ifelse(pMCMC < 0.05, "*", "")) %>%
  within(
    Cross.ID <- str_remove_all(Cross.ID, "Cross.ID")
    ) %>%        
  right_join(
    original.dat %>%
      select(taxa, species.pair, Cross.ID) %>%
      distinct_all(),
    .
  ) %>%
  within(taxa <- ordered(taxa, levels = c("Neuroptera", "Coleoptera", "Diptera", "Lepidoptera", "Orthoptera", "Aves", "Rodentia", "Anura", "Cichliformes"))) %>%
  as.data.frame %>%
  arrange(taxa, species.pair) %>%
  kable("html", digits = 3, caption = "Fixed effects") %>% 
  kable_styling("striped", position = "left")

### Random effects output ###  
# transformation for estimate
# summary(phylmix$Sol/sqrt(1+c2))
# transformation for varaince
summary(phylmix$VCV)$statistics %>%
  as.data.frame %>%
  kable("html", digits = 3, caption = "Random effects") %>% 
  kable_styling("striped", position = "left")

```
d<sub>mismatch</sub> vary among crossings. Although d<sub>mismatch</sub>>0, several estimates were <0. Also, random effects were quite large.


### Regression for raw d<sub>mismatch</sub> 
```{r}

dat3 <- dat %>% 
  drop_na(Genet.divergence, Reciprocal, Hetero.sex, Distribution)

# phylmix <-MCMCglmm(
#   fixed = Mismatch ~  Genet.divergence + Reciprocal + Hetero.sex + Distribution,
#   # idh(SE):units | weight by SE of effect size
#   random = ~ Study.ID + sp1.name + Cross.ID + Hybrid,
#   verbose = FALSE,
#   ginverse = list(sp1.name = phylo_MCMC),
#   nitt = 60000,  # Increase the number of iterations, default is 13000
#   burnin = 5000,  # Increase the number of burnin, default is 3000
#   data = dat3
# )
# saveRDS(phylmix, file = "../Analysis/mismatch.reg.obj")

phylmix <- readRDS("../Analysis/mismatch.reg.obj")

### Fixed effects output ###
summary(phylmix)$solutions %>% 
  kable("html", digits = 3) %>% kable_styling("striped", position = "left")

### Random effects output ###  
summary(phylmix$VCV)$statistics %>%
  as.data.frame %>%
  kable("html", digits = 3, caption = "Random effects") %>% 
  kable_styling("striped", position = "left")

```
None of species level moderators do not influence d<sub>mismatch</sub> 

### Regression for raw d<sub>mismatch</sub> 
```{r}

dat4 <- dat3 %>%
  drop_na(Mismatch.log) %>%
  filter(Mismatch.log != Inf)

# phylmix <-MCMCglmm(
#   fixed = Mismatch.log ~  Genet.divergence + Reciprocal + Hetero.sex + Distribution,
#   # idh(SE):units | weight by SE of effect size
#   random = ~ Study.ID + sp1.name + Cross.ID + Hybrid,
#   verbose = FALSE,
#   ginverse = list(sp1.name = phylo_MCMC),
#   nitt = 60000,  # Increase the number of iterations, default is 13000
#   burnin = 5000,  # Increase the number of burnin, default is 3000
#   data = dat4
# )
# saveRDS(phylmix, file = "../Analysis/mismatch.reg.log.obj")

phylmix <- readRDS("../Analysis/mismatch.reg.log.obj")

### Fixed effects output ###
summary(phylmix)$solutions %>% 
  kable("html", digits = 3) %>% kable_styling("striped", position = "left")

### Random effects output ###  
summary(phylmix$VCV)$statistics %>%
  as.data.frame %>%
  kable("html", digits = 3, caption = "Random effects") %>% 
  kable_styling("striped", position = "left")

```
Model did not converge well