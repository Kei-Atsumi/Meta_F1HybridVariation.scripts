---
title: "General pattern of phenotypic variation"
author: "Keisuke Atsumi"
date: '`r format(Sys.time(), "%y/%m/%d %H:%M")`'
output:
  html_document:
    code_folding: hide
    theme: united
    toc: yes
    toc_float: yes
---

# Setup 

## Loading packages
```{r setup, include=FALSE}

rm(list=ls())  # reset workspace
sessionInfo()  # show R version etc
options(scipen=100)  # do not show numbers using exponential

# load packages
pacman::p_load(
  tidyverse,
  kableExtra,
  pander,     # nice tables
  metafor,    # Meta-analysis
  knitr,      # rmarkdown
  magrittr,   # Extend pipe
  ape,        # Phylogeny
  phytools,   # Phylogeny
  svglite,    # Export SVG plots
  ggbeeswarm, # bee-swarm plots
  plotly      # interactive plots using ggplot2
)

opts_chunk$set(prompt=TRUE, message=FALSE, comment="", warning = FALSE)
options(knitr.kable.NA = '') # Hide NAs in kable table

```


## Custom functions

```{r custom functions}

# General modeling functions Functions for I2

#' Title Function to obtain total and separate I2 from multilevel-meta-analytic model
#'
#' @param model 
#' @param method 
#'
#' @return
#' @export
#'
#' @examples
I2 <- function(model, method = c("Wolfgang", "Shinichi")) {
    
    ## evaluate choices
    method <- match.arg(method)
    
    # Wolfgang's method
    if (method == "Wolfgang") {
        W <- solve(model$V)
        X <- model.matrix(model)
        P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
        I2_total <- sum(model$sigma2)/(sum(model$sigma2) + (model$k - model$p)/sum(diag(P)))
        I2_each <- model$sigma2/(sum(model$sigma2) + (model$k - model$p)/sum(diag(P)))
        names(I2_each) = paste0("I2_", model$s.names)
        
        # putting all together
        I2s <- c(I2_total = I2_total, I2_each)
        
        # or my way
    } else {
        # sigma2_v = typical sampling error variance
        sigma2_v <- sum(1/model$vi) * (model$k - 1)/(sum(1/model$vi)^2 - sum((1/model$vi)^2))
        I2_total <- sum(model$sigma2)/(sum(model$sigma2) + sigma2_v)  #s^2_t = total variance
        I2_each <- model$sigma2/(sum(model$sigma2) + sigma2_v)
        names(I2_each) = paste0("I2_", model$s.names)
        
        # putting all together
        I2s <- c(I2_total = I2_total, I2_each)
    }
    return(I2s)
}


#' Title: the function to get prediction intervals (crediblity intervals) from rma objects (metafor)
#'
#' @param model: rma.mv object 
#' @param mod: the name of a moderator 
get_pred <- function(model, mod = " ") {
    name <- as.factor(str_replace(row.names(model$beta), mod, ""))
    len <- length(name)
    
    if (len != 1) {
        newdata <- matrix(NA, ncol = len, nrow = len)
        for (i in 1:len) {
            # getting the position of unique case from X (design matrix)
            pos <- which(model$X[, i] == 1)[[1]]
            newdata[, i] <- model$X[pos, ]
        }
        pred <- predict.rma(model, newmods = newdata)
    } else {
        pred <- predict.rma(model)
    }

    table <- tibble(
      'Dataset' = "",
      'Fixed effects' = name, 
      'Estimate' = model$beta, # regression: estimate
      'LowerCI' = model$ci.lb, # regression: 95ci, 
      'UpperCI'  = model$ci.ub, # regression: 95ci
      'lowerPR' = pred$cr.lb,  # lower prediction range
      'upperPR' = pred$cr.ub, # lower prediction range
      'P'        = model$pval,
      'V[species with phylogeny]' =
        c(model$sigma2[1], rep("", length(model$beta)-1)),
      'V[study]' =
        c(model$sigma2[2], rep("", length(model$beta)-1)),
      'V[crossed strain]' =
        c(model$sigma2[3], rep("", length(model$beta)-1))
      )  %>%
    mutate(significance = ifelse(P < 0.05, "*", ""))
}

#' Title: the function to get summary stats from rma objects (metafor)
#'
#' @param model: rma.mv object 
#' @param mod: the name of a moderator 
get_stats <- function(model, mod = " ") {
    name <- as.factor(str_replace(row.names(model$beta), mod, ""))
    estimate <- model$beta # regression: estimate
    lowerCI <- model$ci.lb # regression: 95ci
    upperCI <- model$ci.ub # regression: 95ci
    P       <- model$pval
    
    table <- tibble(
      name = name, estimate = estimate,
      lowerCI = lowerCI, upperCI = upperCI,
      P = P
      )  %>%
      mutate(significance = ifelse(P < 0.05, "*", ""))
}


#' Title: the function to get summary stats from rma objects (metafor)
#'
#' @param model: rma.mv object 
#' @param mod: the name of a moderator 
get_reg <- function(model, mod = " ") {
  
  table <- tibble(
    'Dataset' = "",
    'Fixed effects' = c("", row.names(model$beta)),
    'Estimate' = c("", model$beta), # regression: estimate
    'LowerCI' = c("", model$ci.lb), # regression: 95ci, 
    'UpperCI'  = c("", model$ci.ub), # regression: 95ci
    'P'        = c("", model$pval),
    'V[species with phylogeny]' =
      c(model$sigma2[1], rep("", length(model$beta))),
    'V[study]' =
      c(model$sigma2[2], rep("", length(model$beta))),
    'V[crossed strain]' =
      c(model$sigma2[3], rep("", length(model$beta)))
    )  %>%
    as.data.frame() %>%
    mutate_at(vars('Estimate':'V[crossed strain]'), as.numeric) %>%
    mutate(significance = ifelse(P < 0.05, "*", ""))
}

```


## Load data   
```{r load data}

### Phenotypic and metadata ###

# Load effect sizes
mean.dif <- read.csv("../data/variation.ES.general.csv", head = TRUE)%>%
  # indicate dataset including TS
  mutate(data.type = "withTS")

# Observations with TS
TS <- read.csv("../data/variation.ES.TS.csv", head = TRUE) %>%
  filter(yi < 0) %>%
  distinct(ES.ID)
# Effect sizes without observations with TS
noTS <- read.csv("../data/variation.ES.general.csv", head = TRUE) %>%
  filter(!ES.ID %in% unique(TS$ES.ID)) %>%
  # indicate dataset without TS
  mutate(data.type = "withoutTS")

# combine dataset with/without TS
with.without.TS <- bind_rows(mean.dif, noTS) %>%
  mutate(metaunit =  str_c(data.type, cross, sep = "_")) %>%
  # Use observations with both reciprocal crosses
  drop_na(contains("Mn"), contains("SD")) %>%
  # Insect or no
  mutate(
    insect = ifelse(taxa %in% c("Teleost", "Amphibian", "Bird", "Mammal"), "no", "insect"),
  )

### Phylogeny ###

# compute branch lengths of tree
phylo_branch <- read.tree(file = "../data/phylo.variation.general.tre") %>%
  compute.brlen(bin.tree, method = "Grafen", power = 1)

# saving phylogeneic matrix
phylo_cor <- vcv(phylo_branch, cor = T)

# generating inverse phylogenetic matrix for MCMCglmm
# Note one of the tips is called "Lates calcarifer (estimated)"
phylo_branch$node.label <- NULL
phylo_MCMC <- MCMCglmm::inverseA(phylo_branch, nodes = "ALL", scale = TRUE)$Ainv

# Calculate midparent 
midparent <- with.without.TS %>%
  # Divide mean by 2 in spL whereas hybrids are constant
   mutate(
     CV.spL = SD.spL/Mn.spL,
     CV.spS = SD.spS/Mn.spS
     ) %>%
   mutate(
     lnCVR.midparent.es =
       ifelse(
         cross == "spL",
         # log(CVe/CVc)
         log((CV.spL + CV.spS)/2) - log(CV.spS) +  
           # 1/2(Ne-1) - 1/2(Nc-1)
           1/(N.spL + N.spS -2) - 1/(2*N.spS - 2), 
         yi
         )
     # Divide variance by 4 in spL whereas hybrids are constant
     ) %>%
   mutate_at("cross", as.factor) %>%
   within(levels(cross) <- c("hybLS", "hybSL", "midparent"))

```

# Assessing dominance in variance
Compare midparent and hybrids by comparing difference in CV from spS to midparent (spL+spS/2) and to hybrids.    
phenotypic difference from spS to midparent: *((spL+spS/2)/SS)*   
phenotypic difference from spS to hybrids: *(hyb/SS)*  
As the variance of *((spL+spS/2)/SS)*, we use the variance of *(LL/SS)* for simplicity

```{r assessing dominance}

################################################
# phylogenetic random regresson (ANOVA)
################################################

for (j in c("withTS", "withoutTS")) {
  for (k in c("alltaxon", "insect")) {
    
    if (k == "alltaxon") {
      dat <- midparent %>% 
        filter(data.type == j)
    } else {
      dat <- midparent %>% 
        filter(data.type == j, insect == k)
    }

    # # Regress by lnRR of phenotypic difference between parentals
    # midparent.compare <- rma.mv(
    #   yi = lnCVR.midparent.es, V = vi,
    #   data = dat,
    #   method = "REML",
    #   random = list(~1 | spL.name, ~1 | Study.ID, ~1 | Cross.ID),
    #   R = list(spL.name = phylo_cor),
    #   mods = ~ relevel(cross, ref = "midparent")
    #   )
    # ### Save model ###
    # saveRDS(
    #   midparent.compare,
    #   file = paste("../Analysis/Variation.midparent.compare", j, k, "obj", sep = ".")
    #   )
  
    ### Load model ###
    midparent.compare <- readRDS(paste("../Analysis/Variation.midparent.compare", j, k, "obj", sep = "."))
    
    assign(
      paste("Dominance", j,k, sep = "."),
      get_reg(midparent.compare) %>%
        # Show dataset name
        within(Dataset <- c(paste(j,k), rep("", length(.$Estimate)-1))) %>%
        # Rename fixed effects
        within('Fixed effects' <- c("", "midparent (intrcpt)", "hybLS", "hybSL")) %>%
        # Difference with midparent in %
        mutate('Comparison with midparent' = c(
          rep("", 2),
          paste(
            round(
            100*(exp(midparent.compare$beta[1]+midparent.compare$beta[2])            -exp(midparent.compare$beta[1])), # hybrid LS
            2),
            "% larger"
            ),
          paste(
            round(
            100*(exp(midparent.compare$beta[1]+midparent.compare$beta[3])-exp(midparent.compare$beta[1])), # hybrid SL
            2),
            "% larger"
            )
          ))
      )

    #############################################
    # Meta-analysis for midparent to plot band
    #############################################
    
    # # Phylogenetic random meta-analysis
    # midparent.random <- rma.mv(
    #   yi = lnCVR.midparent.es,
    #   V = vi,
    #   data = dat %>%
    #     filter(cross == "midparent"),
    #   method = "REML",
    #   random = list(~1 | spL.name, ~1 | Study.ID, ~1 | Cross.ID, ~1 | ES.ID),
    #   R = list(spL.name = phylo_cor)
    #   )
    # ### Save model ###
    # saveRDS(
    #   midparent.random,
    #   file = paste("../Analysis/Variation.midparent", j, k, "obj", sep = ".")
    #   )
  
    
    ### Load model ###
    midparent.random <- readRDS(paste("../Analysis/Variation.midparent", j, k, "obj", sep = "."))
    # creating summary table of results
    assign(
      paste("midparent.ma", j, k, sep = "."),
      # Prediction interval of midparent
      get_pred(midparent.random) %>%
        as.data.frame() %>%
        mutate(
          data.type = j,
          taxon = k
          )
    )
    
  }
}

bind_rows(
  Dominance.withTS.alltaxon, Dominance.withoutTS.alltaxon,
  Dominance.withTS.insect, Dominance.withoutTS.insect
  ) %>%
  kable("html", digits = 3) %>% kable_styling("striped", position = "left")


### Midparent meta-analysis result for plot below ###
midparent.ma <- bind_rows(
  midparent.ma.withTS.alltaxon, midparent.ma.withoutTS.alltaxon,
  midparent.ma.withTS.insect, midparent.ma.withoutTS.insect
)

```

Both reciprocal hybrids had smaller variance than midparent-of-variance

# Meta-analysis for each hybrids and parental
Calculate meta-analytic mean of lnCVR between less varied parental and the other crosses (hybrids and more varied parental)  
Confidential interval : thick line  
Prediction interval : thin line

```{r meta-analysis for each}

for (j in c("withTS", "withoutTS")) {
  for (k in c("alltaxon", "insect")) {
    for (h in c("spL", "hybLS", "hybSL")) {

      if (k == "alltaxon") {
        dat <- with.without.TS %>% 
          filter(cross == h, data.type == j)
      } else {
        dat <- with.without.TS %>% 
          filter(cross == h, data.type == j, insect == k)
      }
      
      # # Phylogenetic random meta-analysis
      # phyl.random <- rma.mv(
      #   yi = yi, V = vi, 
      #   data = dat, method = "REML",
      #   random = list(~1 | spL.name, ~1 | Study.ID, ~1 | Cross.ID, ~1 | ES.ID),
      #   R = list(spL.name = phylo_cor)
      #   )
      # saveRDS(phyl.random,
      #   file = paste("../Analysis/Variation.meta", j, k, h, "obj", sep = "."))

          

      ### Load model ###
      phyl.random <- readRDS(paste("../Analysis/Variation.meta", j, k, h, "obj", sep = "."))
      # Funnel plot
      funnel(phyl.random, xlab = paste(j, k, h))
      # creating summary table of results
      assign(
        paste("res", h, sep = "."), 
        get_pred(phyl.random) %>%
          as.data.frame() %>%
          mutate(
            N = length(dat$ES.ID),
            I2 = I2(phyl.random)["I2_total"] %>% round(3),
            cross = h # indicate cross (spL, hybLS, hybSL)
            )
          )
      
    }
    
    # Bind result of all crosses at each dataset
    assign(
      paste("res.ma", j,k, sep = "."),
      res.ma <- bind_rows(
        res.spL, res.hybLS, res.hybSL
        ) %>%
        as.data.frame() %>%
        within('Dataset' <- c(paste(j,k), "", "")) # Show dataset name in first row
    )
    
    ### Midparent estimate & CI ###
    midparent.ma.2 <- midparent.ma %>%
      filter(data.type == j, taxon == k)
    
    # creating a forest plot
    plot.metamean <- ggplot(
      data = res.ma, 
      aes(x = tanh(Estimate), y = cross)
      ) +
      scale_y_discrete(expand = c(0,1)) +
      scale_x_continuous(
        limits = c(-1, 1), 
        breaks = seq(-1, 1, by = 0.5)
        ) +
      ### Midparent CI ###
      geom_rect(
        aes(
          xmin = tanh(midparent.ma.2$LowerCI),
          xmax = tanh(midparent.ma.2$UpperCI),
          ymin = -Inf, ymax = Inf
          ),
        fill="Grey 95", inherit.aes = FALSE
        ) +
      ### Midparent estimate ###
      geom_vline(
        xintercept = tanh(midparent.ma.2$Estimate), colour = "grey20", 
        alpha = 0.3, size = 1
        ) +
      ### Orchard plot ###
      geom_quasirandom(
        data = with.without.TS %>%
          filter(data.type == j), 
        aes(x = tanh(yi), y = cross, size = 1/vi, color = cross),
        alpha = 0.2, groupOnX = FALSE
        ) + 
      scale_color_manual(values = c("#DC267F", "#785EF0", "#FE6100")) +
      # Delete legend for colors
      guides(fill = "none", colour = "none") +
      ### Confidential interval ###
      geom_errorbarh(
        aes(xmin = tanh(LowerCI), xmax = tanh(UpperCI)), 
        height = 0, size = 1.2, alpha = 0.6
        ) + 
      ### Prediction interval ### 
      geom_errorbarh(
        aes(xmin = tanh(lowerPR), xmax = tanh(upperPR)), 
        height = 0.1, size = 0.5, alpha = 0.6
        ) +
      geom_vline(xintercept = 0, linetype = 2, colour = "black", alpha = 0.3) + 
      ### Estimate ###
      geom_point(size = 3, shape = 21, fill = "black") + 
      ### I^2 ###
      annotate(
        "text", x = -0.93, y = c(1.35, 2.35, 3.35),
        label = paste("italic(I^2)==", res.ma$I2), 
        parse = TRUE, hjust = "left", size = 5
      ) + 
      ### N ###
      annotate(
        "text", x = -0.93, y = 4.35,
        label = paste("italic(N)==", res.ma$N), 
        parse = TRUE, hjust = "left", size = 5
      ) + 
      ylab("") +
      xlab(expression(
        paste("hyperbolic tangent of lnCVR from ", italic("spSS")), 
        parse = TRUE
        )) +
      ggtitle(paste("Dataset", j, k, "N =", res.ma$N, "each")) +
      theme_bw() +
      theme(
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(size = 14, color = "black", face = "italic"),
        axis.text.x = element_text(size = 14, color = "grey20"),
        axis.title = element_text(size = 14, color = "black"),
        legend.position = c(0, 0),
        legend.justification = c(0, 0),
        legend.direction = "horizontal",
        legend.background = element_blank()
        )
  
    print(plot.metamean)
    
    ggsave(
      plot = plot.metamean,
      file = paste("../Analysis/variation.general.metamean", j, k, "svg", sep = "."), 
    height = 5, width = 5.5
    )

  }
}

bind_rows(
  res.ma.withTS.alltaxon, res.ma.withoutTS.alltaxon,
  res.ma.withTS.insect, res.ma.withoutTS.insect
  ) %>%
  as.data.frame() %>%
  mutate_at(vars('Estimate':'V[crossed strain]'), as.numeric) %>%
  select(Dataset, cross, Estimate, UpperCI, LowerCI, contains("PR"), contains("V")) %>%
  kable("html", digits = 3) %>% kable_styling("striped", position = "left")

```


# comparing mean across all crosses
Comparing the differences between parentals and hybrids

```{r comparing mean across all crosses}

for (j in c("withTS", "withoutTS")) {
  for (k in c("alltaxon", "insect")) {
    
    if (k == "alltaxon") {
      dat <- with.without.TS %>% 
        filter(data.type == j)
    } else {
      dat <- with.without.TS %>% 
        filter(data.type == j, insect == k)
    }

  ###############################################
  # phylogenetic random regresson (ANOVA)
  ###############################################
  # # Regress by lnRR of phenotypic difference between parentals
  # phyl.random.spL <- rma.mv(
  #   yi = yi, V = vi,
  #   data = dat, method = "REML",
  #   random = list(~1 | spL.name, ~1 | Study.ID, ~1 | Cross.ID),
  #   R = list(spL.name = phylo_cor),
  #   mods = ~ relevel(cross, ref = "spL")
  #   )
  # phyl.random.hybLS <- rma.mv(
  #   yi = yi, V = vi,
  #   data = dat, method = "REML",
  #   random = list(~1 | spL.name, ~1 | Study.ID, ~1 | Cross.ID),
  #   R = list(spL.name = phylo_cor),
  #   mods = ~ cross
  #   )
  # # Save model ###
  # saveRDS(
  #   phyl.random.spL,
  #   file = paste("../Analysis/Variation.compare.from.spL", j, k, "obj", sep = ".")
  #   )
  # saveRDS(
  #   phyl.random.hybLS,
  #   file = paste("../Analysis/Variation.compare.from.hybLS", j, k, "obj", sep = ".")
  #   )


  ### Load model ###
  # phyl.random.spL <- readRDS(paste("../Analysis/Variation.compare.from.spL", j, k, "obj", sep = "."))
  phyl.random.hybLS <- readRDS(paste("../Analysis/Variation.compare.from.hybLS", j, k, "obj", sep = "."))
  
  assign(
    paste("Reciprocal", j,k, sep = "."),
    get_reg(phyl.random.hybLS) %>%
      # Show dataset name
      within(Dataset <- c(paste(j,k), rep("", length(.$Estimate)-1))) %>%
      # Rename fixed effects
      within('Fixed effects' <- c("", "hybLS (intrcpt)", "hybSL", "spLL")) %>%
      # Difference with midparent in %
      mutate('Comparison with hybridLS' = c(
        rep("", 2),
        paste(
          round(
            (exp(phyl.random.hybLS$beta[1]+phyl.random.hybLS$beta[2]) -
               exp(phyl.random.hybLS$beta[1])
             )*100,
            2),
          "% larger"
          ), 
        ""
        )
      )
    )
  }
}

bind_rows(
  Reciprocal.withTS.alltaxon, Reciprocal.withoutTS.alltaxon,
  Reciprocal.withTS.insect, Reciprocal.withoutTS.insect
  ) %>%
  kable("html", digits = 3) %>% kable_styling("striped", position = "left")


```

# Meta-regression for lnCVR in hybrids crosses
Which hybrids hybrid more phenotypically vary? What are the affecting factor? Compare lnCVR between hybridLS-speciesS(less vary) vs hybridSL-speciesL(more vary)  

```{r maternal vs paternal, results='asis'}

for (l in c("normal", "sensitivity")) {
  for (j in c("withTS", "withoutTS")) {
    for (k in c("alltaxon", "insect")) {
      
      if (k == "alltaxon") {
        dat <- with.without.TS %>% 
          filter(data.type == j, cross != "spL")
      } else {
        dat <- with.without.TS %>% 
          filter(data.type == j, insect == k, cross != "spL")
      }
      
      # if (l == "normal") {
      # # Regress by lnRR of phenotypic difference between parentals
      # phyl.random <- rma.mv(
      #   yi = yi, V = vi,
      #   data = dat, method = "REML",
      #   random = list(~1 | spL.name, ~1 | Study.ID, ~1 | Cross.ID),
      #   R = list(spL.name = phylo_cor),
      #   mods = ~ cross*hetero.sex +
      #     pheno.div.ratio + divergence.COI +
      #     trait.type + distribution
      #   )
      # } else {
      # # Regress by lnRR of phenotypic difference between parentals
      # phyl.random <- rma.mv(
      #   yi = yi, V = vi,
      #   data = dat, method = "REML",
      #   random = list(~1 | spL.name, ~1 | Study.ID, ~1 | Cross.ID),
      #   R = list(spL.name = phylo_cor),
      #   mods = ~ cross*hetero.sex +
      #     pheno.div.ratio + divergence.COI +
      #     trait.type + distribution +
      #     sqrt(vi)                       # add SE
      #   )
      # }
      # saveRDS(
      #   phyl.random,
      #   file = paste("../Analysis/Variation.metareg", j, k, l, "obj", sep = ".")
      #   )
      
      ### Load model ###
      phyl.random <- readRDS(paste("../Analysis/Variation.metareg", j, k, l, "obj", sep = "."))
      ### Output result ###
      reg <- get_stats(phyl.random)
      plot <- ggplot(reg, aes(y = estimate, x = name)) +
        geom_errorbar(
          aes(ymin = lowerCI, ymax = upperCI, colour=significance), 
          width=.0001
          ) +
      # Color of plots and errorbars
      scale_colour_manual(values = c("grey60", "black")) +
      geom_point(size = 1.5, aes(colour = significance)) +
      scale_fill_manual(values = c("grey60", "black")) +
        scale_x_discrete(limits = rev(reg$name))+ # reverse x-axis
        geom_hline(yintercept = 0, linetype="dashed", size = 0.3) +
        coord_flip() +
        ylab("") + xlab(paste(l, k, j)) +
        theme_bw() +
        theme(
          panel.grid = element_blank(),
          legend.position = "none",
          panel.border=element_blank(),
          axis.text.x = element_text(size = 11),
          axis.text.y = element_text(size = 12),
          axis.line=element_line(colour = "grey70")
          )
      print(plot)
          
      get_reg(phyl.random) %>%
        mutate_if(is.numeric, round, 3) %>%
        # Show dataset name
        within(Dataset <- c(paste(j,k), rep("", length(.$Estimate)-1))) %>%
        kable("html", digits = 3, caption = paste(l,j,k)) %>% 
        kable_styling("striped", position = "left") %>%
        print()
  
    }
  }
}

```

Significant effect was "both crosses of hybrid tend to become vary as parental species phenotypically diverges" only.


# PET-PEESE
Meta regression for spLL, hybSL, hybLS and midparent only including V (lnRR.sv or lnCVR.sv) as a moderator -> intercept indicates adjusted effect size (no error)

```{r PET-PEESE in variation}

for (j in c("withTS", "withoutTS")) {
  for (k in c("alltaxon", "insect")) {
    
    if (k == "alltaxon") {
      midparent.dat <- midparent %>%
        filter(data.type == j)
    } else {
      midparent.dat <- midparent %>%
        filter(data.type == j, insect == k)
    }
    # Phylogenetic random meta-analysis for midparent
    midparent.random <- rma.mv(
      yi = yi, V = vi,
      data = midparent.dat %>% filter(cross == "midparent"),
      method = "REML",
      mods = ~ vi,
      random = list(~1 | spL.name, ~1 | Study.ID, ~1 | Cross.ID, ~1 | ES.ID),
      R = list(spL.name = phylo_cor)
      )
    ### Save model ###
    saveRDS(
      midparent.random,
      file = paste("../Analysis/variation.PET-PEESE.midparent", j, k, "obj", sep = ".")
      )

    ### Load model ###
    midparent.random <- readRDS(paste("../Analysis/variation.PET-PEESE.midparent", j, k, "obj", sep = "."))
    # creating summary table of results
  
    midparent.ma <- get_reg(midparent.random) %>%
      as.data.frame() %>%
      mutate(
        N = length(midparent.dat$ES.ID),
        I2 = I2(midparent.random)["I2_total"] %>% round(3),
        cross = "midparent" # indicate cross (spL, hybLS, hybSL)
        )

    for (h in c("spL", "hybLS", "hybSL")) {

      if (k == "alltaxon") {
        dat <- with.without.TS %>%
          filter(cross == h, data.type == j)
      } else {
        dat <- with.without.TS %>%
          filter(cross == h, data.type == j, insect == k)
      }
      # Phylogenetic random meta-analysis
      phyl.random <- rma.mv(
        yi = yi, V = vi,
        data = dat, method = "REML",
        mods = ~ vi,
        random = list(
          ~1 | spL.name, ~1 | Study.ID, ~1 | Cross.ID, ~1 | ES.ID
          ),
        R = list(spL.name = phylo_cor)
        )
      saveRDS(phyl.random,
        file = paste("../Analysis/variation.PET-PEESE", j, k, h, "obj", sep = "."))

      
      ### Load model ###
      phyl.random <- readRDS(paste("../Analysis/variation.PET-PEESE", j, k, h, "obj", sep = "."))
      
      assign(
        paste("res", h, sep = "."), 
        get_reg(phyl.random) %>%
          as.data.frame() %>%
          mutate(
            N = length(dat$ES.ID),
            I2 = I2(phyl.random)["I2_total"] %>% round(3),
            cross = h # indicate cross (spL, hybLS, hybSL)
            )
          )
      
    }
    
    # Bind result of all crosses at each dataset
    assign(
      paste("res.ma", j,k, sep = "."),
      res.ma <- bind_rows(
        res.spL, res.hybLS, res.hybSL, midparent.ma
        ) %>%
        as.data.frame() %>%
        within('Dataset' <- c(paste(j,k), rep("", length = 11))) # Show dataset name in first row
    )
    
    res.ma.plot <- res.ma %>%
      filter(`Fixed effects` == "intrcpt") %>%
      filter(cross != "midparent")
    
    # creating a forest plot
    plot.metavariation <- ggplot(
      data = res.ma.plot,
      aes(x = Estimate, y = cross)
      ) +
      # scale_x_continuous(
      #   limits = c(-1, 1),
      #   breaks = seq(-1, 1, by = 0.25)
      #   ) +
      # Delete legend for colors
      guides(fill = "none", colour = "none") +
      # Confidential interval : thicker line
      geom_errorbarh(
        aes(xmin = LowerCI, xmax = UpperCI, color = cross),
        height = 0, size = 1.2, alpha = 0.6
        ) +
      geom_vline(xintercept = 0, linetype = 2, colour = "black", alpha = 0.3) +
      ### Estimate ###
      geom_point(size = 3, shape = 21, aes(fill = cross, color = cross)) +
      scale_color_manual(values = c("#DC267F", "#785EF0", "#FE6100")) +
      scale_fill_manual(values = c("#DC267F", "#785EF0", "#FE6100")) +
      ylab("") +
      xlab(paste("PET-PEESE dataset", j,k)) +
      # ### Midparent CI ###
      # geom_rect(
      #   aes(
      #     xmin = res.ma[12, "LowerCI"],
      #     xmax = res.ma[12, "UpperCI"],
      #     ymin = -Inf, ymax = Inf
      #     ),
      #   fill="Grey 80", inherit.aes = FALSE
      #   ) +
      ### Midparent estimate ###
      geom_vline(
        xintercept = res.ma[12, "Estimate"], colour = "grey20",
        alpha = 0.3, size = 1
        ) +
      theme_bw() +
      theme(
        axis.text.y = element_text(size = 13, color = "black", face = "italic"),
        axis.text.x = element_text(size = 11, color = "grey20"),
        axis.title = element_text(size = 13, color = "black"),
        legend.position = c(0, 1),
        legend.justification = c(0, 1),
        legend.direction = "horizontal",
        legend.background = element_blank()
        )

    print(plot.metavariation)
    #     
    # 
    # ggsave(
    #   plot = plot.metavariation,
    #   file = paste("../Analysis/variation.general.metavariation", j,k, "svg", sep = "."),
    #   height = 5, width = 6
    #   )
  }
}

bind_rows(
  res.ma.withTS.alltaxon, res.ma.withoutTS.alltaxon,
  res.ma.withTS.insect, res.ma.withoutTS.insect
  ) %>%
  as.data.frame() %>%
  mutate_at(vars('Estimate':'V[crossed strain]'), as.numeric) %>%
  select(Dataset, cross, 'Fixed effects', Estimate, UpperCI, LowerCI, contains("PR"), contains("V")) %>%
  kable("html", digits = 3) %>% kable_styling("striped", position = "left")

```
