---
title: "General pattern of phenotypic variation without TS"
author: "Keisuke Atsumi"
date: '`r format(Sys.time(), "%y/%m/%d %H:%M")`'
output:
  html_document:
    code_folding: hide
    theme: united
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}

rm(list=ls())  # reset workspace
sessionInfo()  # show R version etc
options(scipen=100)  # do not show numbers using exponential

# install & load packages
# install.packages("tidyverse" ,"metafor", "openxlsx", "data.table")
library(tidyverse)  # dataset modification
library(metafor)    # meta-analysis!
library(knitr)
library(ape)        # Phylogeny
library(phytools)   # Phylogeny
library(svglite)    # Export SVG plots
library(reshape2)   # bar-plot
library(ggsci)      # bar-plot

opts_chunk$set(prompt=TRUE, message=FALSE, comment="", warning = FALSE)

mytheme <- 
  theme(
    panel.grid = element_blank(),
    axis.ticks.y=element_blank(),
    axis.title = element_text(size=20),
    axis.text = element_text(size=17, color = "black"),
    axis.line.y = element_blank(),
    strip.text = element_text(size=12, lineheight=5.0),
    strip.background = element_rect(fill = "white")
  )

```

## *Phylogenetic data*    

```{r load data}

# Observations with TS
TS <- read.csv("../data/variation.ES.TS.csv", head = TRUE) %>%
  filter(yi < 0) %>%
  distinct(ES.ID)

# Effect sizes without observations with TS
mean.dif <- read.csv("../data/variation.ES.general.csv", head = TRUE) %>%
  filter(!ES.ID %in% unique(TS$ES.ID))

# Select ESs that can compare maternal and paternal inheritance
hybrids <- mean.dif %>%
  filter(cross != "spL")

# compute branch lengths of tree
phylo_branch <- read.tree(file = "../data/phylo.variation.general.tre") %>%
  compute.brlen(bin.tree, method = "Grafen", power = 1)

# check tree is ultrametric
is.ultrametric(phylo_branch) # TRUE

# saving phylogeneic matrix
phylo_cor <- vcv(phylo_branch, cor = T)

# generating inverse phylogenetic matrix for MCMCglmm
# Note one of the tips is called "Lates calcarifer (estimated)"
phylo_branch$node.label <- NULL
phylo_MCMC <- MCMCglmm::inverseA(phylo_branch, nodes = "ALL", scale = TRUE)$Ainv

```

# Meta-analysis for each hybrids and parental
Calculate meta-analytic mean of lnCVR between less varied parental and the other crosses (hybrids and more varied parental)

```{r meta-analysis for each}


for (h in c("spL", "hybLS", "hybSL")) {
  
  # Make data for each cross
  split.data <- mean.dif %>%
    # use observations which both crosses are availabe to compare the heterogeneity of both crosses
    filter(reciprocal == "Viable") %>%
    filter(cross == h)
  
  print(paste(h))
  
  # Phylogenetic random meta-analysis
  phyl.random <- rma.mv(
    yi = yi, 
    V = vi, 
    data = split.data, method = "REML",
    random = list(~1 | spL.name, ~1 | Study.ID, ~1 | Cross.ID, ~1 | ES.ID),
    R = list(spL.name = phylo_cor)
    )
  
  # Funnel plot
  funnel(phyl.random)

  assign(
    paste("res", h, sep = "."), 
    cbind(
      phyl.random$beta,   # regression: estimate
      phyl.random$ci.lb,  # regression: 95ci 
      phyl.random$ci.ub,  # regression: 95ci
      phyl.random$pval   # P
      ) %>%
      as.data.frame() %>%
      rename(estimate = V1, ci.lb = V2, ci.ub = V3, P = V4) %>%
    mutate(cross = h)
    )

  # Calculate I^2 for heterogeneity
  # http://www.metafor-project.org/doku.php/tips:i2_multilevel_multivariate
  W <- diag(1/split.data$vi)
  X <- model.matrix(phyl.random)
  P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
  I2 <- 100 * sum(phyl.random$sigma2) / (sum(phyl.random$sigma2) + (phyl.random$k-phyl.random$p)/sum(diag(P)))
  print(paste("I^2 =", I2))
  
}
  
res.allcrosss <- bind_rows(res.spL, res.hybLS, res.hybSL) %>%
  as.data.frame()

plot.metamean <- ggplot(res.allcrosss, aes(y = estimate, x = cross)) +
  geom_bar(stat = "identity", fill = "grey30") +
  geom_errorbar(
    aes(ymin = estimate, ymax = ci.ub), 
    colour="black", width=.00001
    ) +
  scale_x_discrete(limits = rev(res.allcrosss$factors))+ # reverse x-axis
  ylab("lnCVR from spS") + xlab("") +
  mytheme

print(plot.metamean)

ggsave(
  plot = plot.metamean + theme_classic(), 
  file = "../Analysis/variation.general.metamean.svg", 
  height = 2.5, width = 2.3
)

```


# Assessing dominance in variance
Compare midparent and hybrids by comparing difference in CV from spS to midparent (spL+spS/2) and to hybrids.    
phenotypic difference from spS to midparent: *((spL+spS/2)/SS)*   
phenotypic difference from spS to hybrids: *(hyb/SS)*  
As the variance of *((spL+spS/2)/SS)*, we use the variance of *(LL/SS)* for simplicity

```{r assessing dominance}

# Calculate midparent 
midparent <- mean.dif %>%
  # Divide mean by 2 in spL whereas hybrids are constant
   mutate(
     CV.spL = SD.spL/Mn.spL,
     CV.spS = SD.spS/Mn.spS
     ) %>%
   mutate(
     lnCVR.midparent.es =
       ifelse(
         cross == "spL",
         # log(CVe/CVc)
         log((CV.spL + CV.spS)/2) - log(CV.spS) +  
           # 1/2(Ne-1) - 1/2(Nc-1)
           1/(N.spL + N.spS -2) - 1/(2*N.spS - 2), 
         yi
         )
     # Divide variance by 4 in spL whereas hybrids are constant
     ) %>%
   mutate_at("cross", as.factor) %>%
   within(levels(cross) <- c("hybLS", "hybSL", "midparent"))


################################################
# phylogenetic random regresson (ANOVA)
################################################
# Regress by lnRR of phenotypic difference between parentals 
midparent.random <- rma.mv(
  yi = yi, V = vi, data = midparent, method = "REML",
  random = list(~1 | spL.name, ~1 | Study.ID, ~1 | Cross.ID),
  R = list(spL.name = phylo_cor),
  mods = ~ relevel(cross, ref = "midparent")
  )
  
summary(midparent.random)

print(paste("hybLS is larger than midparent in",
    round(
      (exp(midparent.random$beta[1]+midparent.random$beta[2]) -
         exp(midparent.random$beta[1])
       )*100,
      2),
    "percent"))
print(paste("hybSL is larger than midparent in",
    round(
      (exp(midparent.random$beta[1]+midparent.random$beta[3]) -
         exp(midparent.random$beta[1])
       )*100,
      2),
    "percent"))

```

Both reciprocal hybrids had smaller variance than midparent-of-variance

# comparing mean across all crosses
Comparing the differences between parentals and hybrids

```{r comparing mean across all crosses}


################################################
# phylogenetic random regresson (ANOVA)
################################################
# Regress by lnRR of phenotypic difference between parentals 
phyl.random.spL <- rma.mv(
  yi = yi, V = vi, 
  data = mean.dif, method = "REML",
  random = list(~1 | spL.name, ~1 | Study.ID, ~1 | Cross.ID),
  R = list(spL.name = phylo_cor),
  mods = ~ relevel(cross, ref = "spL")
  )

phyl.random.hybLS <- rma.mv(
  yi = yi, V = vi, 
  data = mean.dif, method = "REML",
  random = list(~1 | spL.name, ~1 | Study.ID, ~1 | Cross.ID),
  R = list(spL.name = phylo_cor),
  mods = ~ cross
  )


summary(phyl.random.spL)
summary(phyl.random.hybLS)


```



# Meta-analysis & regression for lnCVR in hybrids crosses
Which hybrids hybrid more phenotypically vary? What are the affecting factor? Compare lnCVR between hybridLS-speciesS(less vary) vs hybridSL-speciesL(more vary)  

```{r maternal vs paternal}

phyl.random <- rma.mv(
  yi = yi, 
  V = vi, 
  data = hybrids, method = "REML",
  random = list(~1 | spL.name, ~1 | Study.ID, ~1 | Cross.ID),
  R = list(spL.name = phylo_cor),
  mods = ~ cross + pheno.div.ratio + cross*hetero.sex + divergence.COI + sq.divergence.COI + distribution
  )

# print(summary(phyl.random))

################################################
# Output result
################################################

reg <- cbind(
  phyl.random$beta,   # regression: estimate
  phyl.random$ci.lb,  # regression: 95ci 
  phyl.random$ci.ub,  # regression: 95ci
  phyl.random$pval   # P
  ) %>%
  cbind(., row.names(.)) %>%
  as.data.frame() %>%
  rename(estimate = V1, ci.lb = V2, ci.ub = V3, P = V4, factors = V5) %>%
  mutate_all(as.character) %>%
  mutate_at(vars(estimate:P), as.numeric) %>%
  mutate_at(vars(factors), as.factor)


plot <- ggplot(reg, aes(y = estimate, x = factors)) +
  geom_rect(
    aes(ymin= -0.5, ymax= 0.5,xmin=-Inf,xmax=Inf),
    fill="Grey 95", inherit.aes = FALSE
    )+
  geom_errorbar(
    aes(ymin = ci.lb, ymax = ci.ub), 
    colour="black", width=.0001
    ) +
  geom_point(size=3, colour="black")+
  scale_shape_manual(values=c(17, 16)) +
  scale_x_discrete(limits = rev(reg$factors))+ # reverse x-axis
  geom_hline(yintercept = 0, linetype="dashed", size = 0.3) +
  coord_flip() +
  ylab("") + xlab("") +
  mytheme

print(plot)

ggsave(
  plot = plot, 
  file = "../Analysis/variation.general.result.svg", 
  height = 4.5, width = 4
  )

print(
  reg %>%
    as.data.frame() %>%
    mutate_if(is.numeric, round, 3) %>%
    column_to_rownames("factors")
  )

```

Significant effect was "both crosses of hybrid tend to become vary as parental species phenotypically diverges" only.
