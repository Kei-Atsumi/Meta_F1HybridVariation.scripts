---
title: "Greater or smaller phenotypic variance in hybrids"
author: "Keisuke Atsumi"
date: '`r format(Sys.time(), "%y/%m/%d %H:%M")`'
output:
  html_document:
    code_folding: hide
    theme: united
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}

rm(list=ls())  # reset workspace
sessionInfo()  # show R version etc
options(scipen=100)  # do not show numbers using exponential

# install & load packages
# install.packages("tidyverse" ,"metafor", "openxlsx", "data.table")
library(tidyverse)  # dataset modification
library(metafor)    # meta-analysis!
library(knitr)
library(openxlsx)
library(ape)        # Phylogeny
library(phytools)        # Phylogeny
library(MCMCglmm)
library(svglite)
opts_chunk$set(prompt=TRUE, message=FALSE, comment="", warning = FALSE) 

mytheme <- 
  theme(
    panel.grid = element_blank(),
    axis.ticks.y=element_blank(),
    axis.title = element_text(size=12),
    axis.text = element_text(size=11),
    axis.line.y = element_blank(),
    strip.text = element_text(size=12, lineheight=5.0),
    strip.background = element_rect(fill = "lightgrey")
  )

```

# transgressive segregation


```{r transgressive segregation}

dat <- read.csv("../data/variation.ES.TS.csv", head = TRUE) %>%
  # Assign transgressive segregation to 1, no TS to 0 for each effect size
  mutate(TS = ifelse(yi < 0, 1, 0)) %>%
  ### Join with metadata ###
  left_join(
    .,
    read.xlsx(
      "../data/original.data.xlsx", sheet = "Metadata"
      )
    ) %>%
  mutate_at(vars(divergence.cytb:surv.relat.hyb21), as.numeric) %>%
  mutate_at(
    vars(contains("divergence"), contains("surv.relat")), scale
    ) %>%
  as.data.frame %>%
  select(-trait) %>%
  drop_na(hetero.sex, pheno.div.diff, trait.type, divergence.COI) %>%
  # order taxon
  within(
    taxa <- ordered(
      taxa,
      levels = c(
        "Teleost", "Amphibian", "Bird", "Mammal",
        "Diptera", "Lepidoptera", "Neuroptera", 
        "Orthoptera","Coleoptera" 
        )
      )
    ) %>%
  mutate_if(is.character, as.factor)

#### Phylogenetic tree for mcmcglmm ####

# compute branch lengths of tree
phylo_branch <- read.tree(file = "../data/phylo.variation.TS.tre") %>%
  compute.brlen(bin.tree, method = "Grafen", power = 1)

# check tree is ultrametric
is.ultrametric(phylo_branch) # TRUE

# saving phylogeneic matrix
phylo_cor <- vcv(phylo_branch, cor = T)

# generating inverse phylogenetic matrix for MCMCglmm
# Note one of the tips is called "Lates calcarifer (estimated)"
phylo_branch$node.label <- NULL
phylo_MCMC <- MCMCglmm::inverseA(phylo_branch, nodes = "ALL", scale = TRUE)$Ainv

```

# Frequency of TS
How frequent the TS is?  

```{r freq of od}

print("overall frequency of TS")
dat %>%
  group_by(TS) %>%
  summarise(length(unique(ES.ID)))

summary <- bind_rows(
  # All observations
  dat %>%
    group_by(taxa) %>%
    summarise(
      species.pair = length(unique(species.pair)),
      observations = length(unique(ES.ID)),
      study = length(unique(Study.ID))
      ) %>%
    mutate(inherit.pattern = "all")
  ,
  # TS observations
  dat %>%
    filter(TS == "1") %>%
    group_by(taxa) %>%
    summarise(
      species.pair = length(unique(species.pair)),
      observations = length(unique(ES.ID)),
      study = length(unique(Study.ID))
      ) %>%
    mutate(inherit.pattern = "Transgressive segregation")
  ) %>%
  # Assign 0 for no observation of TS
  replace(., is.na(.), "0")
  
  
# Order by taxon

sum.forplot <- summary %>% 
  gather(key = metrics, value = N, -c(taxa, inherit.pattern)) %>%
  within(
    metrics <- ordered(
      metrics,
      levels = c("study", "species.pair", "observations")
      )
    )
  

plot <- ggplot(sum.forplot, aes(x = "", y = N, fill = taxa)) +
  geom_bar(width = 1, stat = "identity") +
  scale_fill_brewer() +
  facet_grid(scale = "free", metrics ~ inherit.pattern) +
  xlab("") +
  mytheme
plot

ggsave(plot = plot, file = "../Analysis/Variation.TS.frequency.svg", height = 5, width = 5)

```


# Seeking factor influences the frequency of transgressive segregation

```{r mixed model}

### Setting prior to logistic regression ###
prior <- list(
  B=list(
    mu = rep(0, 16), # N of coefficient. (level -1) for categorical factors, 1 for continuous factors, 1 for intercept  
    V=gelman.prior(~ direction + divergence.COI + sq.divergence.COI + pheno.div.ratio + parental + trait.type + distribution + reciprocal +
                     direction*divergence.COI + direction*sq.divergence.COI + direction*pheno.div.ratio + direction*parental + direction*trait.type + direction*distribution + direction*reciprocal, 
                        data = dat, # formula and data
                        scale=sqrt(pi^2/3+1))), # error distribution of logistic regression
  R=list(V=1,fix=1),
  # Replicating same G for the number of random effects (here, 4)
  G = list(
    G1 = list(V = 1, nu = 1, alpha.mu = 0, alpha.V = 1000),
    G2 = list(V = 1, nu = 1, alpha.mu = 0, alpha.V = 1000),
    G3 = list(V = 1, nu = 1, alpha.mu = 0, alpha.V = 1000),
    G4 = list(V = 1, nu = 1, alpha.mu = 0, alpha.V = 1000)
    )
  )

### Phylogenetic binomial regression ###
phylmix <-MCMCglmm(
  fixed = TS ~  
    direction + divergence.COI + sq.divergence.COI + pheno.div.ratio +
    parental + trait.type + distribution + reciprocal +
    direction*divergence.COI + direction*sq.divergence.COI + 
    direction*pheno.div.ratio +
    direction*parental + direction*trait.type +
    direction*distribution + direction*reciprocal,
  family = "categorical",
  # idh(SE):units | weight by SE of effect size
  random = ~ Study.ID + Cross.ID + spL.name + idh(SE):units,
  verbose = FALSE,
  ginverse = list(spL.name = phylo_MCMC), 
  prior = prior,
  data = dat
)


### Correcting estimate ###
c2 <- (16 * sqrt(3)/(15 * pi))^2

sum <- left_join(
  # corrected estimates & SD
  summary(phylmix$Sol/sqrt(1+c2))$statistics %>%
    as.data.frame() %>%
    rownames_to_column(var = "factors") %>%
    mutate_at("factors", as.factor),
  # P
  summary(phylmix)$solutions %>%
  as.data.frame() %>%
  rownames_to_column(var = "factors") %>%
  mutate_at("factors", as.factor) 
  ) %>%
  mutate(significance = ifelse(pMCMC < 0.05, "*", ""))

### Plot ###
metaplot <- ggplot(sum, aes(y = post.mean, x = factors)) +
  geom_hline(
    yintercept = 0, size = 1, 
    colour = "white" #, linetype = "dotted"         
    ) +
  geom_errorbar(
    aes(
      ymin = sum[, 'l-95% CI'], ymax = sum[, 'u-95% CI'],
      colour=significance 
      ), 
    width=.0001
    ) +
  scale_colour_manual(values = c("black", "#D41159"), aesthetics = "colour") +
  geom_point(size = 1.5, aes(colour=significance))+
  scale_fill_manual(values = c("black", "#D41159"), aesthetics = "colour") +
  scale_x_discrete(limits = rev(sum$factors))+ # reverse x-axis
  coord_flip() +
  mytheme +
  theme(legend.position = "none")

ggsave(
    plot = metaplot, 
    file = "../Analysis/variation.TS.result.svg", 
    height = 5.5, width = 4.5
    )

print(metaplot)

### Output result ###

print(
  sum %>% 
    select(factors, Mean, SD, pMCMC, significance) %>%
    mutate_at(c("Mean", "SD"), round, 2)
  )

# transformation for estimate
# summary(phylmix$Sol/sqrt(1+c2))
# transformation for varaince
summary(phylmix$VCV/(1+c2))

```

*direction+* greater variation in hybrids  
 
TS in Variation is likely to occur toward father species   
Variation of F1 hybrids is usually smaller than parentals when TS in Variation occurs  


