---
title: "Variation General trends 2 ES calculation"
author: "Keisuke Atsumi"
date: '`r format(Sys.time(), "%y/%m/%d %H:%M")`'
output:
  html_document:
    code_folding: hide
    theme: united
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}

rm(list=ls())  # reset workspace
options(scipen=100)  # do not show numbers using exponential

pacman::p_load(
  tidyverse,
  kableExtra,
  pander,     # nice tables
  metafor,    # Meta-analysis
  knitr,      # rmarkdown
  magrittr,   # Extend pipe
  rotl,       # Create phylogenetic tree using Open Tree of Life
  ape,        # Phylogeny
  phytools,   # Phylogeny
  svglite,    # Export SVG plots
  ggbeeswarm, # bee-swarm plots
  plotly      # interactive plots using ggplot2
)
opts_chunk$set(prompt=TRUE, message=FALSE, comment="", warning = FALSE) 

```

# Difference in variation from less vary parentals to the parental and hybrids  


```{r CVR between small parentals and the others}

# load spLS files
dat <- read.csv("../data/dat.CV.csv", head = TRUE)

# Order by taxon
dat$taxa <- ordered(
  dat$taxa,
  levels = c("Neuroptera", "Coleoptera", "Diptera", "Lepidoptera", "Orthoptera", "Aves", "Rodentia", "Anura", "Cichliformes")
  )

for (i in c("hybLS", "hybSL", "spL")) { # identify type of hybrids
  for (h in c("spS")) { # identify type of parentals
    assign(
      paste(i, h, sep = "_"),
        escalc(
          measure = "CVR",
          # N of hybrids
          n1i = dat[, paste("N", i, sep = ".")],
          # N of parentals
          n2i = dat[, paste("N", h, sep = ".")],
          # Mean of hybrids
          m1i = dat[, paste("Mn", i, sep = ".")],
          # Mean of parentals
          m2i = dat[, paste("Mn", h, sep = ".")],
          # SD of hybrids
          sd1i = dat[, paste("SD", i, sep = ".")],
          # SD of parentals
          sd2i = dat[, paste("SD", h, sep = ".")],
          data = dat
          ) %>%
          mutate(cross = i) 
    )
  }
}

# Combine all ES datasets
CV.dif <- bind_rows(
  hybLS_spS, hybSL_spS, spL_spS
  ) %>%
  drop_na(yi) %>%
  arrange(ES.ID) %>%
  left_join(., dat) 

```


# Funnel plots

```{r funnel plot}

res <- rma(yi = yi, vi = vi, data = CV.dif, method="FE")

### set up 2x2 array for plotting
par(mfrow=c(2,2))
### draw funnel plots
funnel(res, main="Standard Error", xlim = c(-5, 5))
funnel(res, yaxis="vi", main="Sampling Variance", xlim = c(-5, 5))
funnel(res, yaxis="seinv", main="Inverse Standard Error", xlim = c(-5, 5))
funnel(res, yaxis="vinv", main="Inverse Sampling Variance", xlim = c(-5, 5))

```

# Check data
Checked data of extremely high/low standard error and confirmed that those data were correctly imported. *ES390* was the cause of huge heterogeneity in lnCVR between spSS and hybSL


```{r check, results='asis'}

outliers <- CV.dif %>%
  # vi (sampling variance) 
  mutate(SE = sqrt(vi)) %>%
  arrange(desc(SE)) %>%
  filter(SE > 1.2 | 1/SE > 8.5) %>%
  select(ES.ID, Study.name, SE, cross, reciprocal, trait, Cross.ID) %>%
  mutate_if(is.numeric, round, 3)

outliers %>%
  kable("html", digits = 3) %>% 
  kable_styling("striped", position = "left")

print("remove observatons included the outliers")
CV.dif.2 <- CV.dif %>%
  filter(!ES.ID %in% unique(outliers$ES.ID)) 
write.csv(CV.dif.2, "../data/variation.ES.general.csv", row.names = F)

```

# Funnel plots again

```{r funnel plot again}

res <- rma(yi = yi, vi = vi, data = CV.dif.2, method="FE")
### set up 2x2 array for plotting
par(mfrow=c(2,2))
### draw funnel plots
funnel(res, main="Standard Error", xlim = c(-5, 5))
funnel(res, yaxis="vi", main="Sampling Variance", xlim = c(-5, 5))
funnel(res, yaxis="seinv", main="Inverse Standard Error", xlim = c(-5, 5))
funnel(res, yaxis="vinv", main="Inverse Sampling Variance", xlim = c(-5, 5))

```



# Phenotypic data sumamry

```{r dataset summary}

summary <- CV.dif.2 %>%
  group_by(taxa) %>%
  summarise(
    species.pair = length(unique(species.pair)),
    observations = length(unique(ES.ID)),
    study = length(unique(Study.ID))
    )

bind_rows(
  summary,
  summary %>%
    summarise_if(is.numeric, sum) %>%
    mutate(taxa = "total")
  ) %>%
  column_to_rownames(var = "taxa")

# Order by taxon

sum.forplot <- summary %>% 
  gather(key = metrics, value = N, -taxa)
sum.forplot$metrics <- ordered(
  sum.forplot$metrics,
  levels = c(
    "study", "species.pair", "observations"
    )
  )

plot <- ggplot(sum.forplot, aes(x = "", y = N, fill = taxa)) +
  geom_bar(width = 1, stat = "identity") +
  scale_fill_brewer() +
  facet_grid(scale = "free", rows = "metrics") +
  xlab("")
plot

# ggsave(plot = plot, file = "../Analysis/dat.variation.general.svg", height = 5, width = 3.5)

```

# Phylogeny

```{r phylogeny}

# # matching names from open tree taxonomy
# taxa <- tnrs_match_names(
#   names = levels(CV.dif$spL.name) %>%
#     str_replace_all("_", " "), 
#   context_name = "Animals"
#   )
# 
# # Create tree
# tree <- tol_induced_subtree(ott_ids = taxa$ott_id)
# tree$tip.label %<>%
#   strip_ott_ids # remove OTT IDs from tip labels
# # randomly solve non-binary phylogeny
# set.seed(6)
# bin.tree <- multi2di(tree, random = T)
# 
# # Fix names of tip labels
# bin.tree$tip.label %<>% str_replace_all("Dryophytes", "Hyla")
# # Indicate mismatch between tip labels & dataset species names
# setdiff(levels(as.factor(bin.tree$tip.label)), levels(CV.dif$spL.name))
# setdiff(levels(CV.dif$spL.name), levels(as.factor(bin.tree$tip.label)))

write.tree(bin.tree, file= "../data/phylo.variation.general.tre")

```

  
  
  
  