---
title: "Transgressive segregation in mean phenotype"
author: "Keisuke Atsumi"
date: '`r format(Sys.time(), "%y/%m/%d %H:%M")`'
output:
  html_document:
    code_folding: hide
    theme: united
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}

rm(list=ls())  # reset workspace
sessionInfo()  # show R version etc
options(scipen=100)  # do not show numbers using exponential

# install & load packages
# install.packages("tidyverse" ,"metafor", "openxlsx", "data.table")
library(tidyverse)  # dataset modification
library(metafor)    # meta-analysis!
library(knitr)
library(openxlsx)
library(ape)        # Phylogeny
library(phytools)        # Phylogeny
library(MCMCglmm)
library(svglite)
opts_chunk$set(prompt=TRUE, message=FALSE, comment="", warning = FALSE) 

mytheme <- 
  theme(
    panel.grid = element_blank(),
    axis.ticks.y=element_blank(),
    axis.title = element_text(size=12),
    axis.text = element_text(size=11),
    axis.line.y = element_blank(),
    strip.text = element_text(size=12, lineheight=5.0),
    strip.background = element_rect(fill = "lightgrey")
  )

```

# Exploring frequency of transgressive segregation and it affecting factors

```{r TS}

TS <- read.csv("../data/mean.ES.TS.csv", head = TRUE) %>%
  # Assign overdoinance to 1, no TS to 0 for each effect size
  mutate(TS = ifelse(SMD.es < 0, 1, 0)) %>%
  ### Join with metadata ###
  left_join(
    .,
    read.xlsx(
      "../data/original.data.xlsx", sheet = "Metadata"
      )
    ) %>%
  mutate_at(vars(divergence.cytb:surv.relat.hyb21), as.numeric) %>%
  mutate_at(
    vars(contains("divergence"), contains("surv.relat")), scale
    ) %>%
  as.data.frame %>%
  select(-trait) %>%
  drop_na(hetero.sex, pheno.div.diff, trait.type, divergence.COI) %>%
  mutate_at("taxa", as.factor) %>%
  within(levels(TS) <- c("No", "Transgressive segregation")) %>%
  within(
    taxa <- ordered(
      taxa,
      levels = c(
        "Teleost", "Amphibian", "Bird", "Mammal",
        "Diptera", "Lepidoptera", "Neuroptera", 
        "Orthoptera","Coleoptera" 
        )
      )
    )


#### Phylogenetic tree for mcmcglmm ####

# compute branch lengths of tree
phylo_branch <- read.tree(file = "../data/phylo.mean.TS.tre") %>%
  compute.brlen(bin.tree, method = "Grafen", power = 1)

# check tree is ultrametric
is.ultrametric(phylo_branch) # TRUE

# saving phylogeneic matrix
phylo_cor <- vcv(phylo_branch, cor = T)

# generating inverse phylogenetic matrix for MCMCglmm
# Note one of the tips is called "Lates calcarifer (estimated)"
phylo_branch$node.label <- NULL
phylo_MCMC <- MCMCglmm::inverseA(phylo_branch, nodes = "ALL", scale = TRUE)$Ainv

```

# Frequency of TS
How frequent the TS is?  

```{r freq of od}

print("overall frequency of TS")
TS %>%
  group_by(TS) %>%
  summarise(length(unique(ES.ID)))

summary <- bind_rows(
  # All observations
  TS %>%
    group_by(taxa) %>%
    summarise(
      species.pair = length(unique(species.pair)),
      observations = length(unique(ES.ID)),
      study = length(unique(Study.ID))
      ) %>%
    mutate(inherit.pattern = "all")
  ,
  # TS observations
  TS %>%
    filter(TS == "1") %>%
    group_by(taxa) %>%
    summarise(
      species.pair = length(unique(species.pair)),
      observations = length(unique(ES.ID)),
      study = length(unique(Study.ID))
      ) %>%
    mutate(inherit.pattern = "Transgressive segregation")
  ) %>%
  # Assign 0 for no observation of TS
  replace(., is.na(.), "0")
  
  
# Order by taxon

sum.forplot <- summary %>% 
  gather(key = metrics, value = N, -c(taxa, inherit.pattern)) %>%
  within(
    metrics <- ordered(
      metrics,
      levels = c("study", "species.pair", "observations")
      )
    )
  

plot <- ggplot(sum.forplot, aes(x = "", y = N, fill = taxa)) +
  geom_bar(width = 1, stat = "identity") +
  scale_fill_brewer() +
  facet_grid(scale = "free", metrics ~ inherit.pattern) +
  xlab("") +
  mytheme
plot

ggsave(plot = plot, file = "../Analysis/mean.TS.frequency.svg", height = 5, width = 5)


```

# Seeking factor influences the frequency of TS
Previous study (Stelkens et al 2009 Evolution) showed TS in F1 become frequent as parental species diverges in plant. How about male sexual traits in animals?  
Does TS biased toward larger phenotypic value? -> <i>parentalspS</i> will negative   
Does TS biased toward father species? -> <i>patmatmother</i> will negative



```{r mixed model}

phylmix <-MCMCglmm(
  fixed = TS ~ 
    divergence.COI + sq.divergence.COI + trait.type + pheno.div.diff + hetero.sex + distribution + parental + direction,
  random = ~ Study.ID + Cross.ID + spL.name + ES.ID,
  family = "categorical",
  verbose = FALSE,
  ginverse = list(spL.name = phylo_MCMC), 
  data = TS
)

summary(phylmix)

sum <- summary(phylmix)$solutions %>%
  as.data.frame() %>%
  rownames_to_column(var = "factors") %>%
  mutate_at("factors", as.factor)


metaplot <- ggplot(sum, aes(y = post.mean, x = factors)) +
  geom_rect(
    aes(ymin= -0.5, ymax= 0.5,xmin=-Inf,xmax=Inf),
    fill="Grey 95", inherit.aes = FALSE
    ) +
  geom_errorbar(
    aes(ymin = sum[, 'l-95% CI'], ymax = sum[, 'u-95% CI']), 
    colour="black", width=.0001
    ) +
  geom_point(size=3, colour="black")+
  scale_x_discrete(limits = rev(sum$factors))+ # reverse x-axis
  geom_hline(yintercept = 0, linetype="dashed", size = 0.3) +
  coord_flip() +
  mytheme

ggsave(
    plot = metaplot, 
    file = "../Analysis/mean.TS.result.svg", 
    height = 4, width = 3.5
    )

print(metaplot)

# plot.phenodiv <- ggplot(
#   od %>%
#   within(levels(TS) <- c("No", "TS")),
#   aes(x = Mn.spL/Mn.spS, y = TS)
#   ) +
#   geom_point() +
#   xlab("Phenotypic divergence between parentals (Larger/Smaller)") +
#   ylab("") +
#   mytheme

# plot.genediv <- ggplot(
#   od %>%
#   within(levels(TS) <- c("No", "TS")),
#   aes(x = divergence.COI, y = TS)
#   ) +
#   geom_point() +
#   xlab("Genetic divergence between parentals (mtDNA COI)") +
#   ylab("") +
#   mytheme
# 
# 
# print(plot.phenodiv)
# print(plot.genediv)
# ggsave(
#     plot = plot.phenodiv, 
#     file = "../Analysis/TS.phenodiv.svg", 
#     height = 3, width = 4.5
#     )

```

# Results
TS is quite frequent phenomena  
TS become rare as phenotypic divergence between parental species diverges  
Genetic divergence do not affect TS
TS tend to occur toward mother species
