---
title: "Transgressive segregation in mean phenotype"
author: "Keisuke Atsumi"
date: '`r format(Sys.time(), "%y/%m/%d %H:%M")`'
output:
  html_document:
    code_folding: hide
    theme: united
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}

rm(list=ls())  # reset workspace
sessionInfo()  # show R version etc
options(scipen=100)  # do not show numbers using exponential

# install & load packages
pacman::p_load(
  tidyverse,  
  MCMCglmm,   # glmm
  knitr,      # rmarkdown
  magrittr,   # Extend pipe
  ape,        # Phylogeny
  phytools,   # Phylogeny
  svglite    # Export SVG plots
)
opts_chunk$set(prompt=TRUE, message=FALSE, comment="", warning = FALSE) 

mytheme <- 
  theme(
    panel.grid = element_blank(),
    axis.ticks.y=element_blank(),
    axis.title = element_text(size=12),
    axis.text = element_text(size=11),
    axis.line.y = element_blank(),
    strip.text = element_text(size=12, lineheight=5.0),
    strip.background = element_rect(fill = "lightgrey")
  )

```

# Exploring frequency of transgressive segregation and it affecting factors

```{r TS}

TS <- read.csv("../data/mean.ES.TS.csv", head = TRUE) %>%
  # Assign overdoinance to 1, no TS to 0 for each effect size
  mutate(TS = ifelse(SMD.es < 0, 1, 0)) %>%
  ### Join with metadata ###
  left_join(
    .,
    read.xlsx(
      "../data/original.data.xlsx", sheet = "Metadata"
      )
    ) %>%
  mutate_at(vars(divergence.cytb:surv.relat.hyb21), as.numeric) %>%
  mutate_at(
    vars(contains("divergence"), contains("surv.relat")), scale
    ) %>%
  as.data.frame %>%
  select(-trait) %>%
  drop_na(hetero.sex, pheno.div.diff, trait.type, divergence.COI) %>%
  mutate_at("taxa", as.factor) %>%
  within(levels(TS) <- c("No", "Transgressive segregation")) %>%
  within(
    taxa <- ordered(
      taxa,
      levels = c(
        "Teleost", "Amphibian", "Bird", "Mammal",
        "Diptera", "Lepidoptera", "Neuroptera", 
        "Orthoptera","Coleoptera" 
        )
      )
    )


#### Phylogenetic tree for mcmcglmm ####

# compute branch lengths of tree
phylo_branch <- read.tree(file = "../data/phylo.mean.TS.tre") %>%
  compute.brlen(bin.tree, method = "Grafen", power = 1)

# check tree is ultrametric
is.ultrametric(phylo_branch) # TRUE

# saving phylogeneic matrix
phylo_cor <- vcv(phylo_branch, cor = T)

# generating inverse phylogenetic matrix for MCMCglmm
# Note one of the tips is called "Lates calcarifer (estimated)"
phylo_branch$node.label <- NULL
phylo_MCMC <- MCMCglmm::inverseA(phylo_branch, nodes = "ALL", scale = TRUE)$Ainv

```

# Frequency of TS
How frequent the TS is?  

```{r freq of od}

print("overall frequency of TS")
TS %>%
  group_by(TS) %>%
  summarise(length(unique(ES.ID)))

summary <- bind_rows(
  # All observations
  TS %>%
    group_by(taxa) %>%
    summarise(
      species.pair = length(unique(species.pair)),
      observations = length(unique(ES.ID)),
      study = length(unique(Study.ID))
      ) %>%
    mutate(inherit.pattern = "all")
  ,
  # TS observations
  TS %>%
    filter(TS == "1") %>%
    group_by(taxa) %>%
    summarise(
      species.pair = length(unique(species.pair)),
      observations = length(unique(ES.ID)),
      study = length(unique(Study.ID))
      ) %>%
    mutate(inherit.pattern = "Transgressive segregation")
  ) %>%
  # Assign 0 for no observation of TS
  replace(., is.na(.), "0")
  
  
# Order by taxon

sum.forplot <- summary %>% 
  gather(key = metrics, value = N, -c(taxa, inherit.pattern)) %>%
  within(
    metrics <- ordered(
      metrics,
      levels = c("study", "species.pair", "observations")
      )
    )
  

plot <- ggplot(sum.forplot, aes(x = "", y = N, fill = taxa)) +
  geom_bar(width = 1, stat = "identity") +
  scale_fill_brewer() +
  facet_grid(scale = "free", metrics ~ inherit.pattern) +
  xlab("") +
  mytheme
plot

ggsave(plot = plot, file = "../Analysis/mean.TS.frequency.svg", height = 5, width = 5)

```

# Seeking factor influences the frequency of TS
Previous study (Stelkens et al 2009 Evolution) showed TS in F1 become frequent as parental species diverges in plant. How about male sexual traits in animals?  
Does TS biased toward larger phenotypic value? -> <i>parentalspS</i> will negative   
Does TS biased toward father species? -> <i>patmatmother</i> will negative



```{r mixed model}

### Setting prior to logistic regression ###
prior <- list(
  B=list(
    mu = rep(0, 18), # N of coefficient. (level -1) for categorical factors, 1 for continuous factors, 1 for intercept  
    V = gelman.prior(
      ~ parental*hetero.sex + parental*direction + direction*divergence.COI + direction*sq.divergence.COI + direction*pheno.div.ratio + direction*trait.type + direction*distribution + direction*reciprocal, 
      data = TS, # formula and data
      scale=sqrt(pi^2/3+1))), # error distribution of logistic regression
  R=list(V=1,fix=1),
  G = list(
    G1 = list(V = 1, nu = 1, alpha.mu = 0, alpha.V = 1000),
    G2 = list(V = 1, nu = 1, alpha.mu = 0, alpha.V = 1000),
    G3 = list(V = 1, nu = 1, alpha.mu = 0, alpha.V = 1000),
    G4 = list(V = 1, nu = 1, alpha.mu = 0, alpha.V = 1000)
    )
  )

### Phylogenetic binomial regression ###
phylmix <-MCMCglmm(
  fixed = TS ~ 
    parental*hetero.sex + parental*direction +
    direction*divergence.COI + direction*sq.divergence.COI + 
    direction*pheno.div.ratio + direction*trait.type +
    direction*distribution + direction*reciprocal,
  # idh(SE):units | weight by SE of effect size
  random = ~ Study.ID + Cross.ID + spL.name + idh(SE):units,
  family = "categorical",
  verbose = FALSE,
  ginverse = list(spL.name = phylo_MCMC), 
  prior = prior,
  data = TS
)


### Correcting estimate ###
c2 <- (16 * sqrt(3)/(15 * pi))^2

sum <- left_join(
  # corrected estimates & SD
  summary(phylmix$Sol/sqrt(1+c2))$statistics %>%
    as.data.frame() %>%
    rownames_to_column(var = "factors"),
  # P
  summary(phylmix)$solutions %>%
  as.data.frame() %>%
  rownames_to_column(var = "factors"),
  by = "factors"
  ) %>%
  mutate(significance = ifelse(pMCMC < 0.05, "*", "")) %>%
  ### Grouping factors ###
  mutate(
    group = ifelse(str_detect(factors, "direction.:"), 
                   "increasing trait value",
                   ifelse(str_detect(factors, "parentalMother:"),
                          "polar overdominance",
                          "transgressive segregation"
                          )
                   )
  ) %>%
  mutate_at("group", as.factor) %>%
  within(group <- ordered(group, c("transgressive segregation", "increasing trait value", "polar overdominance"))) %>%
  ### Change factor names ###
  within(
    factors <- str_remove_all(
      factors, "direction.:"
      ) %>%
      str_remove_all(., "parentalMother:")
    ) %>%
  within(
    factors <- factor(
      factors, ordered = TRUE, 
      levels = c("trait.typesound", "hetero.sexmale", "parentalMother", "reciprocalViable", "distributionOverlap", "pheno.div.ratio", "sq.divergence.COI", "divergence.COI",  "direction+", "(Intercept)")
      )
    )

### Plot ###
metaplot <- ggplot(sum, aes(
  x = post.mean, 
  # Inverse order of factors
  y = factors
  )) +
  # Vertical line
  geom_vline(
    xintercept = 0, size = 0.3, 
    colour = "grey30", linetype = "dotted"         
    ) +
  # CI
  geom_errorbarh(
    aes(
      xmin = sum[, 'l-95% CI'], xmax = sum[, 'u-95% CI'],
      colour=significance 
      ), 
    height = .0001
    ) +
  # Color of plots and errorbars
  scale_colour_manual(values = c("grey60", "black")) +
  geom_point(size = 1.5, aes(colour = significance)) +
  scale_fill_manual(values = c("grey60", "black")) +
  # Title
  ylab("") + xlab("estimate with CI") +
  # Combine different plots for main factors and interactions
  facet_grid(group~., scales = "free", space = "free") +
  # Themes
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    panel.border=element_blank(),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 12),
    axis.line=element_line(colour = "grey70")
    )
print(metaplot)

ggsave(
    plot = metaplot, 
    file = "../Analysis/mean.TS.result.svg", 
    height = 6.5, width = 4.5
    )

print(metaplot)

### Output result ###

print(
  sum %>% 
    select(factors, Mean, SD, pMCMC, significance) %>%
    mutate_at(c("Mean", "SD"), round, 2)
  )

# transformation for estimate
# summary(phylmix$Sol/sqrt(1+c2))
# transformation for varaince
summary(phylmix$VCV/(1+c2))

# note for running binary GLMM with MCMCglmm

#######################
# logistic regression #
#######################

# p2<-plogis(m2$Sol[,1]/sqrt(1+c2)) # marginal probability when x=1
# 
# plot(mcmc.list(p1,p2))

```

# Results
TS is quite frequent phenomena  
TS become rare as phenotypic divergence between parental species diverges  
Genetic divergence do not affect TS
TS tend to occur toward mother species
