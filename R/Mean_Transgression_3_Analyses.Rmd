---
title: "Transgressive segregation in mean phenotype"
author: "Keisuke Atsumi"
date: '`r format(Sys.time(), "%y/%m/%d %H:%M")`'
output:
  html_document:
    code_folding: hide
    theme: united
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}

rm(list=ls())  # reset workspace
sessionInfo()  # show R version etc
options(scipen=100)  # do not show numbers using exponential

# install & load packages
# install.packages("tidyverse" ,"metafor", "openxlsx", "data.table")
library(tidyverse)  # dataset modification
library(metafor)    # meta-analysis!
library(knitr)
library(openxlsx)
library(ape)        # Phylogeny
library(phytools)        # Phylogeny
library(MCMCglmm)
library(svglite)
opts_chunk$set(prompt=TRUE, message=FALSE, comment="", warning = FALSE) 

mytheme <- 
  theme(
    panel.grid = element_blank(),
    axis.ticks.y=element_blank(),
    axis.title = element_text(size=12),
    axis.text = element_text(size=11),
    axis.line.y = element_blank(),
    strip.text = element_text(size=12, lineheight=5.0),
    strip.background = element_rect(fill = "lightgrey")
  )

```

# Exploring frequency of transgressive segregation and it affecting factors

```{r TS}

TS <- read.csv("../data/mean.ES.TS.csv", head = TRUE) %>%
  # Assign overdoinance to 1, no TS to 0 for each effect size
  mutate(TS = ifelse(SMD.es < 0, 1, 0)) %>%
  ### Join with metadata ###
  left_join(
    .,
    read.xlsx(
      "../data/original.data.xlsx", sheet = "Metadata"
      )
    ) %>%
  mutate_at(vars(divergence.cytb:surv.relat.hyb21), as.numeric) %>%
  mutate_at(
    vars(contains("divergence"), contains("surv.relat")), scale
    ) %>%
  as.data.frame %>%
  select(-trait) %>%
  drop_na(hetero.sex, pheno.div.diff, trait.type, divergence.COI) %>%
  mutate_at("taxa", as.factor) %>%
  within(levels(TS) <- c("No", "Transgressive segregation")) %>%
  within(
    taxa <- ordered(
      taxa,
      levels = c(
        "Teleost", "Amphibian", "Bird", "Mammal",
        "Diptera", "Lepidoptera", "Neuroptera", 
        "Orthoptera","Coleoptera" 
        )
      )
    )


#### Phylogenetic tree for mcmcglmm ####

# compute branch lengths of tree
phylo_branch <- read.tree(file = "../data/phylo.mean.TS.tre") %>%
  compute.brlen(bin.tree, method = "Grafen", power = 1)

# check tree is ultrametric
is.ultrametric(phylo_branch) # TRUE

# saving phylogeneic matrix
phylo_cor <- vcv(phylo_branch, cor = T)

# generating inverse phylogenetic matrix for MCMCglmm
# Note one of the tips is called "Lates calcarifer (estimated)"
phylo_branch$node.label <- NULL
phylo_MCMC <- MCMCglmm::inverseA(phylo_branch, nodes = "ALL", scale = TRUE)$Ainv

```

# Frequency of TS
How frequent the TS is?  

```{r freq of od}

print("overall frequency of TS")
TS %>%
  group_by(TS) %>%
  summarise(length(unique(ES.ID)))

summary <- bind_rows(
  # All observations
  TS %>%
    group_by(taxa) %>%
    summarise(
      species.pair = length(unique(species.pair)),
      observations = length(unique(ES.ID)),
      study = length(unique(Study.ID))
      ) %>%
    mutate(inherit.pattern = "all")
  ,
  # TS observations
  TS %>%
    filter(TS == "1") %>%
    group_by(taxa) %>%
    summarise(
      species.pair = length(unique(species.pair)),
      observations = length(unique(ES.ID)),
      study = length(unique(Study.ID))
      ) %>%
    mutate(inherit.pattern = "Transgressive segregation")
  ) %>%
  # Assign 0 for no observation of TS
  replace(., is.na(.), "0")
  
  
# Order by taxon

sum.forplot <- summary %>% 
  gather(key = metrics, value = N, -c(taxa, inherit.pattern)) %>%
  within(
    metrics <- ordered(
      metrics,
      levels = c("study", "species.pair", "observations")
      )
    )
  

plot <- ggplot(sum.forplot, aes(x = "", y = N, fill = taxa)) +
  geom_bar(width = 1, stat = "identity") +
  scale_fill_brewer() +
  facet_grid(scale = "free", metrics ~ inherit.pattern) +
  xlab("") +
  mytheme
plot

ggsave(plot = plot, file = "../Analysis/mean.TS.frequency.svg", height = 5, width = 5)

```

# Seeking factor influences the frequency of TS
Previous study (Stelkens et al 2009 Evolution) showed TS in F1 become frequent as parental species diverges in plant. How about male sexual traits in animals?  
Does TS biased toward larger phenotypic value? -> <i>parentalspS</i> will negative   
Does TS biased toward father species? -> <i>patmatmother</i> will negative



```{r mixed model}

### Setting prior to logistic regression ###
prior <- list(
  B=list(mu = rep(0, 10), # N of coefficient. (level -1) for categorical factors, 1 for continuous factors  
         V=gelman.prior(~ divergence.COI + sq.divergence.COI + trait.type + pheno.div.diff + hetero.sex + distribution + parental + direction + reciprocal, data=TS, # formula and data
                        scale=sqrt(pi^2/3+1))), # error distribution of logistic regression
  R=list(V=1,fix=1),
  # Replicating same G for the number of random effects (here, 3)
  G = list(
    G1 = list(V = 1, nu = 1, alpha.mu = 0, alpha.V = 1000),
    G2 = list(V = 1, nu = 1, alpha.mu = 0, alpha.V = 1000),
    G3 = list(V = 1, nu = 1, alpha.mu = 0, alpha.V = 1000))
  )

phylmix <-MCMCglmm(
  fixed = TS ~ 
    divergence.COI + sq.divergence.COI + trait.type + pheno.div.diff + hetero.sex + distribution + parental + direction + reciprocal,
  random = ~ Study.ID + Cross.ID + spL.name,
  family = "categorical",
  verbose = FALSE,
  ginverse = list(spL.name = phylo_MCMC), 
  prior = prior,
  data = TS
)

print("uncorrected summary")
summary(phylmix)

<<<<<<< HEAD
# Correcting estimate 
c2 <- (16 * sqrt(3)/(15 * pi))^2
=======
# transformation for b 
c2 <- (16 * sqrt(3)/(15 * pi))^2
sumamry(phylmix$Sol/sqrt(1+c2))
# transformation for varaince
sumamry(phylmix$VCV/(1+c2))

>>>>>>> 685398d7b6a5eb8f88c1852d8787061d47e424f7

sum <- left_join(
  # corrected estimates & SD
  summary(phylmix$Sol/sqrt(1+c2))$statistics %>%
    as.data.frame() %>%
    rownames_to_column(var = "factors") %>%
    mutate_at("factors", as.factor),
  # P
  summary(phylmix)$solutions %>%
  as.data.frame() %>%
  rownames_to_column(var = "factors") %>%
  mutate_at("factors", as.factor)
)

metaplot <- ggplot(sum, aes(y = Mean, x = factors)) +
  geom_hline(
    yintercept = 0, size = 1, 
    colour = "white" #, linetype = "dotted"         
    ) +
  geom_errorbar(
    aes(ymin = Mean - SD, ymax = Mean + SD), 
    colour="black", width=.0001
    ) +
  geom_point(size=1.5, colour="black")+
  scale_x_discrete(limits = rev(sum$factors))+ # reverse x-axis
  coord_flip() +
  mytheme

ggsave(
    plot = metaplot, 
    file = "../Analysis/mean.TS.result.svg", 
    height = 4, width = 3.5
    )

print(metaplot)

# note for running binary GLMM with MCMCglmm

#######################
# logistic regression #
#######################

# p2<-plogis(m2$Sol[,1]/sqrt(1+c2)) # marginal probability when x=1
# 
# plot(mcmc.list(p1,p2))

```

# Results
TS is quite frequent phenomena  
TS become rare as phenotypic divergence between parental species diverges  
Genetic divergence do not affect TS
TS tend to occur toward mother species
