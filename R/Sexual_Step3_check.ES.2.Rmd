---
title: "Step3_check.EffectSize"
author: "Keisuke Atsumi"
date: '`r format(Sys.time(), "%y/%m/%d %H:%M")`'
output:
  html_document:
    toc: yes
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
rm(list=ls())  # reset workspace
sessionInfo()  # show R version etc
options(scipen=100)  # do not show numbers using exponential

# install & load packages
# install.packages("tidyverse" ,"metafor", "openxlsx", "data.table")
library(tidyverse)  # dataset modification
library(metafor)    # meta-analysis!
library(knitr)

# load Effect sizes
ES.recip <- read.table("../Analysis/sexual.ES.recip.csv", head = TRUE, sep = "\t")
ES.matpat <- read.table("../Analysis/sexual.ES.matpat.csv", head = TRUE, sep = "\t")
ES.epistasis <- read.table("../Analysis/sexual.ES.epistasis.csv", head = TRUE, sep = "\t")
```

# Check whether sampling variance of lnCVR is sensitive for asuumption on correlation

Check whether sampling variance calculated assuming corelation is/is not different between groups.

```{r correlation in sampling variance of lnCVR, include=TRUE, echo=TRUE}

# confirm high correlation between two ways in calculating variance of lnCVR
cor.test(ES.epistasis$lnCVR.sv.corF, ES.epistasis$lnCVR.sv.corT)

```


# Draw funnel plot for each effect sizes

First, check funnel plot to find odd studies (i.e. very large/small effect size and large error variance)

```{r funnel plot, include=TRUE, echo = FALSE}

plot(ES.recip$lnRR.recip.es, sqrt(1/ES.recip$lnRR.recip.sv), 
     xlab = "effect size [lnRR]", ylab="Precision [1/SE]", main="lnRR between reciprocal crosses")
abline(v=0,lty=3)

plot(ES.recip$SMD.recip.es, sqrt(1/ES.recip$SMD.recip.sv), 
     xlab = "effect size [SMD]", ylab="Precision [1/SE]", main="SMD between reciprocal crosses")
abline(v=0,lty=3)

plot(ES.epistasis$lnCVR.es, sqrt(1/ES.epistasis$lnCVR.sv.corF), 
     xlab = "effect size [lnCVR]", ylab="Precision [1/SE]", main="lnCVR between pure & hybrids")
abline(v=0,lty=3)

```

# Drop data with extremely high Precision
In lnRR between cross direction but not in SMD, funnel plot showed extremely high/low Precision in effect sizes, which prevents meta-analysis (regtest was failed due to too large variation in precision).  
This could be due to low variation resulting from inbred strain, but not error in typing.  
Hence, I drop such effect sizes

```{r data elimination, include=TRUE, echo = FALSE}

# eliminate ES with extremely low variance
ES.recip.lnRR <- filter(ES.recip, lnRR.recip.sv > 0.001) %>%
  filter(., lnRR.recip.sv < 1000)
# export dataset
write.table(ES.recip.lnRR, "../Analysis/sexual.ES.lnRR.recip.csv", 
            row.names = F, sep = "\t")
# confirm plot
plot(ES.recip.lnRR$lnRR.recip.es, sqrt(1/ES.recip.lnRR$lnRR.recip.sv), 
     xlab = "effect size [lnRR]", ylab="Precision [1/SE]", main="lnRR between reciprocal crosses")
abline(v=0,lty=3)
```


```{r bias checking}

# Difference in means between cross directions: lnRR
regtest(x = ES.recip.lnRR$lnRR.recip.es, vi = ES.recip.lnRR$lnRR.recip.sv,
        predictor = "vi")
# Difference in means between cross directions: SMD
regtest(x = ES.recip$SMD.recip.es, vi = ES.recip$SMD.recip.sv,
        predictor = "vi")

# Difference in variances
regtest(x = ES.epistasis$lnCVR.es, vi = ES.epistasis$lnCVR.sv.corF,
        predictor = "vi")

```




